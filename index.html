<!DOCTYPE html>
<html>
<head>
    <title>CORSAIR: Naval Legends ONLINE</title>
    <meta charset="UTF-8">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* --- TON STYLE GENERAL (INCHANG√â) --- */
        body { margin: 0; background: #000c18; overflow: hidden; font-family: 'Garamond', serif; color: #ecf0f1; user-select: none; }
        canvas { display: block; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .score-board { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 20px; background: rgba(0,0,0,0.6); padding: 10px 30px; border-radius: 0 0 15px 15px; border: 1px solid #555; border-top: none; }
        .score-team { font-size: 28px; font-weight: bold; text-shadow: 2px 2px 0 #000; min-width: 60px; text-align: center; }
        .blue-team { color: #3498db; } .red-team { color: #e74c3c; }
        .score-target { color: #aaa; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; }
        .hud-top-left { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 15px; }
        .health-container { width: 280px; height: 16px; background: #000; border: 2px solid #daa520; border-radius: 4px; }
        .health-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #8b0000, #ff0000); transition: width 0.3s; }
        #wind-compass { width: 80px; height: 80px; background: #d2b48c; border: 4px solid #5d4037; border-radius: 50%; position: relative; margin-top: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        #wind-arrow { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #wind-arrow::after { content: '‚û§'; font-size: 30px; color: #8b0000; transform: rotate(90deg); }
        #wind-warning { color: #ffcc00; font-weight: bold; font-size: 18px; text-shadow: 2px 2px 0 #000; display: none; margin-top:5px;}
        #boundary-warning { position: absolute; top: 15%; width: 100%; text-align: center; font-size: 45px; color: #ff3333; font-weight: bold; text-shadow: 0 0 20px #000; display: none; }
        .special-ability-ui { display: flex; align-items: center; gap: 10px; margin-top: 10px; display: none; }
        .special-icon { width: 50px; height: 50px; background: #333; border: 2px solid #777; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; transition: 0.3s; position: relative; overflow: hidden; }
        .special-icon.ready { border-color: #00d2d3; box-shadow: 0 0 15px #00d2d3; background: #003333; cursor: pointer; }
        .special-fill { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); transition: height 0.1s; }
        .special-text { font-size: 14px; color: #ccc; text-shadow: 1px 1px 0 #000; font-weight: bold; }
        #repair-msg { position: absolute; bottom: 180px; left: 50%; transform: translateX(-50%); color: #2ecc71; font-weight: bold; font-size: 20px; text-shadow: 1px 1px 0 #000; display:none; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; border: 1px solid #2ecc71; }
        #shop-hint { position: absolute; bottom: 140px; left: 50%; transform: translateX(-50%); color: #f1c40f; font-weight: bold; font-size: 22px; text-shadow: 1px 1px 0 #000; display:none; animation: pulse 1s infinite; background: rgba(0,0,0,0.7); padding: 10px 20px; border: 2px solid #f1c40f; border-radius: 8px; pointer-events: auto; cursor:pointer;}
        @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } 100% { transform: translateX(-50%) scale(1); } }
        #transfer-msg { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 28px; font-weight: bold; text-shadow: 0 0 10px #000; background: rgba(0, 0, 0, 0.7); padding: 20px 40px; border: 2px solid #3498db; border-radius: 8px; display: none; z-index: 10; pointer-events: none; text-align: center; }
        .blink { animation: blinker 0.2s linear 3; }
        @keyframes blinker { 50% { opacity: 0; } }
        .gold-display { font-size: 32px; color: #f1c40f; font-weight: bold; text-shadow: 2px 2px 0 #000; display: flex; align-items: center; gap: 10px; }
        .cannons-ui { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 60px; }
        .cannon-dial { width: 80px; height: 80px; border-radius: 50%; background: #222; border: 4px solid #555; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 13px; color: #888; transition: 0.3s; box-shadow: 0 0 20px #000; }
        .cannon-dial.ready { border-color: #ffcc00; color: #fff; box-shadow: 0 0 25px rgba(255, 204, 0, 0.4); background: #443300; transform: scale(1.1); }
        .cannon-dial .key-hint { font-size: 20px; display: block; margin-bottom: 2px; color: #fff; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 5, 10, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; z-index: 20; backdrop-filter: blur(5px); }
        .menu-panel { background: #1e1e1e; border: 4px solid #daa520; border-radius: 12px; padding: 40px; text-align: center; box-shadow: 0 0 60px rgba(0,0,0,1); position: relative; max-width: 900px; width: 90%; }
        h1 { font-size: 70px; margin: 0; text-transform: uppercase; font-style: italic; color: #daa520; text-shadow: 4px 4px 0 #000; letter-spacing: 4px; }
        h2 { color: #888; margin-top: 5px; font-size: 20px; letter-spacing: 3px; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 20px; margin-bottom: 30px;}
        .desc { color: #ccc; margin: 20px 0; font-size: 18px; }
        .mode-selector, .ship-selector { display: flex; gap: 30px; justify-content: center; margin-top: 30px; flex-wrap: wrap; }
        .mode-btn { background: #333; border: 2px solid #555; padding: 25px; width: 300px; cursor: pointer; transition: 0.3s; border-radius: 8px; }
        .mode-btn:hover { background: #444; border-color: #daa520; transform: translateY(-5px); }
        .mode-title { font-size: 24px; color: #ffcc00; font-weight: bold; display: block; margin-bottom: 10px; }
        .mode-desc { font-size: 14px; color: #bbb; line-height: 1.4; }
        .ship-card { background: rgba(0,0,0,0.3); padding: 15px; border: 1px solid #555; border-radius: 8px; width: 200px; cursor: pointer; transition: 0.2s; }
        .ship-card:hover { border-color: #daa520; transform: translateY(-5px); }
        .ship-title { font-weight: bold; color: #ffcc00; font-size: 20px; margin-bottom: 10px; display:block; }
        .target-hint { font-size: 12px; color: #aaa; margin-top: 5px; }
        .upgrade-box { margin-top: 30px; border-top: 1px solid #444; padding-top: 20px; display:flex; gap:20px; justify-content:center; flex-wrap:wrap;}
        .upgrade-btn { background: #e74c3c; padding: 15px 30px; font-size: 18px; border: 2px solid #c0392b; color: white; cursor: pointer; border-radius: 5px; min-width: 250px; }
        .upgrade-btn:hover { background: #c0392b; }
        button { background: #8b0000; color: #ffcc00; border: 2px solid #ffcc00; padding: 15px 40px; font-size: 20px; font-family: 'Garamond', serif; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 20px;}
        .hidden { display: none !important; }
        #respawn-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(50, 0, 0, 0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 30; }
        #respawn-text { font-size: 60px; color: #e74c3c; font-weight: bold; text-shadow: 0 0 20px #000; }
    </style>
</head>
<body>

<div id="ui-layer" style="display:none;">
    <div id="boundary-warning"‚ö†Ô∏è FIN DU MONDE ‚ö†Ô∏è</div>
    <div class="score-board">
        <div class="score-team blue-team" id="score-blue">0</div>
        <div class="score-target" id="score-target-text">Objectif: 25</div>
        <div class="score-team red-team" id="score-red">0</div>
    </div>
    <div id="repair-msg">üõ†Ô∏è R√âPARATIONS EN COURS üõ†Ô∏è</div>
    <div id="shop-hint" onclick="openShop()">[B] CHANTIER NAVAL</div>
    <div class="hud-top-left">
        <div class="gold-display">üí∞ <span id="gold-val">0</span></div>
        <div class="health-container"><div id="hp-bar" class="health-fill"></div></div>
        <div id="wind-compass"><div id="wind-arrow"></div></div>
    </div>
</div>

<div id="menu-screen" class="overlay">
    <div class="menu-panel">
        <h1>Corsair</h1><h2>Naval Legends</h2>
        <div class="mode-selector">
            <div class="mode-btn" onclick="startGame('BRIG')">
                <span class="mode-title">‚öì REJOINDRE LA BATAILLE</span>
                <span class="mode-desc">Mode multijoueur en ligne.</span>
            </div>
        </div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // --- CONNEXION MULTIJOUEUR ---
    // REMPLACE l'URL par ton URL Render apr√®s avoir cr√©√© le service sur Render.com
    const socket = io('https://corsair-online.onrender.com'); 

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const ZOOM_LEVEL = 0.8; 

    // Variables de jeu
    let ships = []; 
    let player = null; 
    let gameState = 'MENU';
    let bullets = [];
    let islands = [];
    let camera = { x: 0, y: 0 };
    let frameCount = 0;
    let windDirection = Math.PI * 0.25;

    // --- ECOUTE DU SERVEUR ---
    socket.on('currentPlayers', (serverPlayers) => {
        Object.keys(serverPlayers).forEach((id) => {
            if (id !== socket.id) {
                const p = serverPlayers[id];
                createRemoteShip(id, p);
            }
        });
    });

    socket.on('newPlayer', (p) => {
        createRemoteShip(p.id, p);
    });

    socket.on('playerMoved', (p) => {
        const ship = ships.find(s => s.netId === p.id);
        if (ship) {
            ship.x = p.x;
            ship.y = p.y;
            ship.angle = p.angle;
            ship.type = p.type;
        }
    });

    socket.on('playerDisconnected', (id) => {
        ships = ships.filter(s => s.netId !== id);
    });

    function createRemoteShip(id, data) {
        let s = createShip(data.type, data.x, data.y, data.team, false);
        s.netId = id; // Identifiant r√©seau
        ships.push(s);
    }

    // --- TES CONFIGURATIONS (INCHANG√âES) ---
    const SHIP_TYPES = {
        SLOOP: { name: "Sloop", hp: 70, maxSpeed: 2.8, accel: 0.01, turnSpeed: 0.018, turnAccel: 0.0006, cannons: 1, reloadTime: 35, damage: 5, size: 0.8, reward: 50 },
        BRIG: { name: "Brick", hp: 180, maxSpeed: 1.8, accel: 0.006, turnSpeed: 0.010, turnAccel: 0.0003, cannons: 3, reloadTime: 100, damage: 8, size: 1.0, reward: 100 },
        GALLEON: { name: "Galion", hp: 400, maxSpeed: 1.3, accel: 0.003, turnSpeed: 0.006, turnAccel: 0.0001, cannons: 6, reloadTime: 180, damage: 10, size: 1.3, reward: 250 }
    };

    function createShip(typeKey, x, y, team, isPlayer) {
        let stats = SHIP_TYPES[typeKey];
        return {
            type: typeKey, stats: stats, team: team, isPlayer: isPlayer,
            x: x, y: y, angle: 0, speed: 0, turnVel: 0, sailsUp: false,
            hp: stats.hp, maxHp: stats.hp
        };
    }

    // --- INPUTS ---
    const keys = { left: false, right: false, up: false };
    window.addEventListener('keydown', e => {
        if(e.code === 'KeyA' || e.code === 'ArrowLeft') keys.left = true;
        if(e.code === 'KeyD' || e.code === 'ArrowRight') keys.right = true;
        if(e.code === 'KeyW' || e.code === 'ArrowUp') if(player) player.sailsUp = !player.sailsUp;
    });
    window.addEventListener('keyup', e => {
        if(e.code === 'KeyA' || e.code === 'ArrowLeft') keys.left = false;
        if(e.code === 'KeyD' || e.code === 'ArrowRight') keys.right = false;
    });

    function startGame(type) {
        player = createShip(type, 0, 1400, 'blue', true);
        ships.push(player);
        gameState = 'PLAYING';
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'block';
        loop();
    }

    function update() {
        if(gameState !== 'PLAYING') return;

        ships.forEach(s => {
            if (s.isPlayer) {
                // Physique mouvement
                if(keys.left) s.turnVel -= s.stats.turnAccel;
                if(keys.right) s.turnVel += s.stats.turnAccel;
                s.turnVel *= 0.98;
                s.angle += s.turnVel;
                
                if(s.sailsUp) s.speed = Math.min(s.speed + s.stats.accel, s.stats.maxSpeed);
                else s.speed *= 0.99;
                
                s.x += Math.cos(s.angle) * s.speed;
                s.y += Math.sin(s.angle) * s.speed;

                // AJOUT : Envoyer position au serveur
                socket.emit('playerMovement', { x: s.x, y: s.y, angle: s.angle, type: s.type });
                
                // Camera
                camera.x = s.x - (canvas.width/ZOOM_LEVEL)/2;
                camera.y = s.y - (canvas.height/ZOOM_LEVEL)/2;
            }
        });
    }

    function draw() {
        ctx.fillStyle = '#012942';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.save();
        ctx.scale(ZOOM_LEVEL, ZOOM_LEVEL);
        ctx.translate(-camera.x, -camera.y);

        ships.forEach(s => {
            ctx.save();
            ctx.translate(s.x, s.y);
            ctx.rotate(s.angle);
            
            // Dessin simplifi√© du bateau
            ctx.fillStyle = s.team === 'blue' ? '#3498db' : '#e74c3c';
            ctx.fillRect(-20 * s.stats.size, -10 * s.stats.size, 40 * s.stats.size, 20 * s.stats.size);
            
            // Voile
            if(s.sailsUp) {
                ctx.fillStyle = '#fff';
                ctx.fillRect(-5, -15, 10, 30);
            }
            ctx.restore();
        });

        ctx.restore();
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
</script>
</body>
</html>
