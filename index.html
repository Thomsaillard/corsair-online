<!DOCTYPE html>
<html>
<head>
    <title>CORSAIR: Naval Legends</title>
    <meta charset="UTF-8">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* --- STYLE GENERAL (STRICTEMENT INCHANG√â) --- */
        body { margin: 0; background: #000c18; overflow: hidden; font-family: 'Garamond', serif; color: #ecf0f1; user-select: none; }
        canvas { display: block; }

        /* --- UI EN JEU (INCHANG√â) --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .score-board { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 20px; background: rgba(0,0,0,0.6); padding: 10px 30px; border-radius: 0 0 15px 15px; border: 1px solid #555; border-top: none; }
        .score-team { font-size: 28px; font-weight: bold; text-shadow: 2px 2px 0 #000; min-width: 60px; text-align: center; }
        .blue-team { color: #3498db; } .red-team { color: #e74c3c; }
        .score-target { color: #aaa; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; }
        .hud-top-left { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 15px; }
        .health-container { width: 280px; height: 16px; background: #000; border: 2px solid #daa520; border-radius: 4px; }
        .health-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #8b0000, #ff0000); transition: width 0.3s; }
        #wind-compass { width: 80px; height: 80px; background: #d2b48c; border: 4px solid #5d4037; border-radius: 50%; position: relative; margin-top: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        #wind-arrow { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #wind-arrow::after { content: '‚û§'; font-size: 30px; color: #8b0000; transform: rotate(90deg); }
        #boundary-warning { position: absolute; top: 15%; width: 100%; text-align: center; font-size: 45px; color: #ff3333; font-weight: bold; text-shadow: 0 0 20px #000; display: none; }

        /* --- MENUS --- */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 5, 10, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; z-index: 20; backdrop-filter: blur(5px); }
        .menu-panel { background: #1e1e1e; border: 4px solid #daa520; border-radius: 12px; padding: 40px; text-align: center; box-shadow: 0 0 60px rgba(0,0,0,1); position: relative; max-width: 900px; width: 90%; }
        h1 { font-size: 70px; margin: 0; text-transform: uppercase; font-style: italic; color: #daa520; text-shadow: 4px 4px 0 #000; letter-spacing: 4px; }
        h2 { color: #888; margin-top: 5px; font-size: 20px; letter-spacing: 3px; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 20px; margin-bottom: 30px;}
        .mode-selector { display: flex; gap: 30px; justify-content: center; margin-top: 30px; flex-wrap: wrap; }
        .mode-btn { background: #333; border: 2px solid #555; padding: 25px; width: 300px; cursor: pointer; transition: 0.3s; border-radius: 8px; }
        .mode-btn:hover { background: #444; border-color: #daa520; transform: translateY(-5px); }
        button { background: #8b0000; color: #ffcc00; border: 2px solid #ffcc00; padding: 15px 40px; font-size: 20px; font-family: 'Garamond', serif; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 20px;}
        
        /* MULTI START: Style Lobby */
        #lobby-status { font-size: 24px; color: #00d2d3; margin: 20px; }
        .ready-btn { background: #27ae60; border-color: #2ecc71; }
        .ready-btn.waiting { background: #c0392b; border-color: #e74c3c; }
        /* MULTI END */
    </style>
</head>
<body>

<div id="ui-layer" style="display:none;">
    <div id="boundary-warning">‚ö†Ô∏è FIN DU MONDE ‚ö†Ô∏è</div>
    <div class="score-board">
        <div class="score-team blue-team" id="score-blue">0</div>
        <div class="score-target" id="score-target-text">Objectif: 10</div>
        <div class="score-team red-team" id="score-red">0</div>
    </div>
    <div class="hud-top-left">
        <div class="gold-display"><span class="gold-icon">üí∞</span> <span id="gold-val">0</span></div>
        <div class="health-container"><div id="hp-bar" class="health-fill"></div></div>
        <div id="wind-compass"><div id="wind-arrow"></div></div>
    </div>
</div>

<div id="lobby-screen" class="overlay" style="display:none;">
    <div class="menu-panel">
        <h1>SALON MULTI</h1>
        <div id="lobby-status">Attente de joueurs... (1/2)</div>
        <div id="ship-info" style="margin: 20px; color: #aaa;">Tous les joueurs seront en : <b style="color:#ffcc00">BRICK</b></div>
        <button id="ready-btn" class="ready-btn" onclick="toggleReady()">JE SUIS PR√äT</button>
        <button class="btn-secondary" onclick="location.reload()">ANNULER</button>
    </div>
</div>
<div id="menu-screen" class="overlay">
    <div class="menu-panel">
        <h1>Corsair</h1><h2>Naval Legends</h2>
        <div class="mode-selector">
            <div class="mode-btn" onclick="selectMode('EVOLUTION')">‚öì MODE √âVOLUTION</div>
            <div class="mode-btn" onclick="selectMode('FLEET')">‚öîÔ∏è BATAILLE RAPIDE</div>
            <div class="mode-btn" style="border-color: #00d2d3;" onclick="selectMode('MULTI')">üåê MODE MULTIJOUEUR</div>
            </div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // MULTI START: Variables & Connexion
    const socket = io('https://corsair-online.onrender.com');
    let isReady = false;
    let netPlayers = {};
    // MULTI END

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const ZOOM_LEVEL = 0.8; 

    const SHIP_TYPES = {
        SLOOP: { name: "Sloop", typeId: 'small', hp: 70, maxSpeed: 2.8, accel: 0.01, turnSpeed: 0.018, turnAccel: 0.0006, cannons: 1, reloadTime: 35, damage: 5, size: 0.8, burst: true, reward: 50 },
        BRIG: { name: "Brick", typeId: 'medium', hp: 180, maxSpeed: 1.8, accel: 0.006, turnSpeed: 0.010, turnAccel: 0.0003, cannons: 3, reloadTime: 100, damage: 8, size: 1.0, burst: false, reward: 100 },
        GALLEON: { name: "Galion", typeId: 'large', hp: 400, maxSpeed: 1.3, accel: 0.003, turnSpeed: 0.006, turnAccel: 0.0001, cannons: 6, reloadTime: 180, damage: 10, size: 1.3, burst: false, reward: 250 },
        MANOWAR: { name: "Man'o'War", typeId: 'xl', hp: 700, maxSpeed: 0.9, accel: 0.0015, turnSpeed: 0.003, turnAccel: 0.00005, cannons: 7, reloadTime: 240, damage: 14, size: 1.6, burst: false, reward: 500 }
    };

    const PORTS = [{ x: 0, y: 1400, team: 'blue', dockSide: -Math.PI/2 }, { x: 0, y: -1400, team: 'red', dockSide: Math.PI/2 }];
    const WORLD_RADIUS = 5000;
    
    let gameState = 'MENU', gameMode = '', frameCount = 0, windDirection = Math.PI * 0.25;
    let ships = [], player = null, playerGold = 0, bullets = [], islands = [], camera = { x: 0, y: 0 };
    const keys = { left: false, right: false, up: false, fireLeft: false, fireRight: false };

    // --- MULTI START: Gestion Salon ---
    socket.on('lobbyUpdate', (count) => {
        document.getElementById('lobby-status').innerText = `Joueurs connect√©s : ${count} / 2`;
    });

    socket.on('startGameMulti', (data) => {
        // Le serveur lance la partie pour tout le monde
        startGame('BRIG'); 
    });

    socket.on('playerMoved', (p) => {
        if (gameMode !== 'MULTI') return;
        let ship = ships.find(s => s.netId === p.id);
        if (ship) { ship.x = p.x; ship.y = p.y; ship.angle = p.angle; }
        else {
            let s = createShip('BRIG', p.x, p.y, p.team, false);
            s.netId = p.id; ships.push(s);
        }
    });

    function toggleReady() {
        isReady = !isReady;
        document.getElementById('ready-btn').innerText = isReady ? "ATTENTE AUTRE JOUEUR..." : "JE SUIS PR√äT";
        document.getElementById('ready-btn').className = isReady ? "ready-btn waiting" : "ready-btn";
        socket.emit('playerReady', isReady);
    }
    // MULTI END

    function selectMode(mode) {
        gameMode = mode;
        if (mode === 'MULTI') {
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('lobby-screen').style.display = 'flex';
        } else {
            startGame('BRIG');
        }
    }

    // --- FONCTIONS DE DESSIN ORIGINALES (ABSOULEMENT INCHANG√âES) ---
    function drawShip(ctx, ship) {
        let size = ship.stats.size; let type = ship.type;
        ctx.save(); ctx.translate(ship.x, ship.y); ctx.rotate(ship.angle); ctx.scale(size, size);
        ctx.fillStyle = ship.team === 'blue' ? '#5d4037' : '#3e1a1a';
        ctx.beginPath();
        if(type === 'GALLEON' || type === 'MANOWAR') {
            let w = type === 'MANOWAR' ? 70 : 60;
            ctx.moveTo(-50, -18); ctx.bezierCurveTo(-30, -28, 30, -28, w, -5); ctx.lineTo(w+5, 0); ctx.lineTo(w, 5); ctx.bezierCurveTo(30, 28, -30, 28, -50, 18);
        } else if (type === 'SLOOP') { ctx.ellipse(0, 0, 30, 12, 0, 0, Math.PI*2); }
        else { ctx.moveTo(-40, -12); ctx.bezierCurveTo(-20, -18, 20, -18, 50, -2); ctx.lineTo(55, 0); ctx.lineTo(50, 2); ctx.bezierCurveTo(20, 18, -20, 18, -40, 12); }
        ctx.closePath(); ctx.fill(); ctx.stroke();
        let masts = type==='SLOOP' ? [0] : type==='BRIG' ? [-15, 15] : type==='GALLEON' ? [-30, 0, 30] : [-40, -10, 20, 50];
        masts.forEach(mX => {
            ctx.fillStyle = '#3e2723'; ctx.beginPath(); ctx.arc(mX, 0, 4, 0, Math.PI*2); ctx.fill();
            if (ship.sailsUp) { ctx.fillStyle = ship.team === 'blue' ? '#ecf0f1' : '#c0392b'; ctx.fillRect(mX-3, -25, 6, 50); }
        });
        if (ship.isPlayer) { ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.moveTo(0,-20); ctx.lineTo(-10,-30); ctx.lineTo(10,-30); ctx.fill(); }
        ctx.restore();
    }

    function generateIslands() {
        islands = [];
        for(let i=0; i<30; i++) {
            let x = (Math.random()-0.5)*WORLD_RADIUS*1.5;
            let y = (Math.random()-0.5)*WORLD_RADIUS*1.5;
            islands.push({x, y, r: 100+Math.random()*150, type: Math.random()>0.5?'sand':'rock', rotation: Math.random()*Math.PI});
        }
    }

    function createShip(typeKey, x, y, team, isPlayer) {
        let stats = SHIP_TYPES[typeKey];
        return {
            type: typeKey, stats: stats, team: team, isPlayer: isPlayer, x: x, y: y, angle: 0, speed: 0, turnVel: 0, sailsUp: false, hp: stats.hp, maxHp: stats.hp
        };
    }

    function createFleet(team, startX, startY) {
        let s = createShip('BRIG', startX, startY, team, team === 'blue');
        ships.push(s); if(team === 'blue') player = s;
    }

    function startGame(shipType) {
        ships = []; bullets = []; generateIslands();
        createFleet('blue', 0, 1400); 
        if(gameMode !== 'MULTI') createFleet('red', 0, -1400); // Pas d'IA en mode Multi
        
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'block';
        gameState = 'PLAYING'; loop();
    }

    function update() {
        if(gameState !== 'PLAYING') return;
        ships.forEach(s => {
            if (s.isPlayer) {
                if(window.keys.left) s.turnVel -= s.stats.turnAccel;
                if(window.keys.right) s.turnVel += s.stats.turnAccel;
                s.turnVel *= 0.98; s.angle += s.turnVel;
                if(s.sailsUp) s.speed = Math.min(s.speed + s.stats.accel, s.stats.maxSpeed); else s.speed *= 0.99;
                s.x += Math.cos(s.angle) * s.speed; s.y += Math.sin(s.angle) * s.speed;
                camera.x = s.x - (canvas.width/ZOOM_LEVEL)/2; camera.y = s.y - (canvas.height/ZOOM_LEVEL)/2;
                
                // MULTI START: Sync
                if(gameMode === 'MULTI') socket.emit('playerMovement', { x: s.x, y: s.y, angle: s.angle });
                // MULTI END
            }
        });
    }

    function draw() {
        ctx.fillStyle = '#012942'; ctx.fillRect(0,0, canvas.width, canvas.height);
        ctx.save(); ctx.scale(ZOOM_LEVEL, ZOOM_LEVEL); ctx.translate(-camera.x, -camera.y);
        islands.forEach(isle => { ctx.fillStyle = isle.type==='sand'?'#e6cca0':'#546e7a'; ctx.beginPath(); ctx.arc(isle.x, isle.y, isle.r, 0, Math.PI*2); ctx.fill(); });
        ships.forEach(s => drawShip(ctx, s));
        ctx.restore();
    }

    function loop() { update(); draw(); requestAnimationFrame(loop); }

    window.keys = keys;
    window.addEventListener('keydown', e => { 
        if(e.code === 'KeyA') keys.left = true; if(e.code === 'KeyD') keys.right = true; 
        if(e.code === 'KeyW') if(player) player.sailsUp = !player.sailsUp;
    });
    window.addEventListener('keyup', e => { if(e.code === 'KeyA') keys.left = false; if(e.code === 'KeyD') keys.right = false; });
</script>
</body>
</html>
